<!DOCTYPE html>
<html lang="en">

<head>
    <title>Users - Admin Dashboard</title>
    <%- include('partical/head'); %>
</head>

<body>
    <div class="wrapper">
        <%- include('partical/sidebar'); %>
        <main class="main-content">
            <%- include('partical/navbar'); %>

            <div class="container-fluid px-4 py-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-4">
                    <h1 class="h3 mb-0">Users Management</h1>
                    <div>
                        <span class="badge bg-primary me-2">Total: <%= typeof totalUsers !== 'undefined' ? totalUsers : 0 %></span>
                        <button type="button" class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                            <i class="fa fa-plus me-2"></i>Add User
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="GET" action="/admin/users" class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" name="search" placeholder="Search by name or email..." value="<%= typeof search !== 'undefined' ? search : '' %>">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" name="role">
                                    <option value="">All Roles</option>
                                    <option value="user" <%= typeof roleFilter !== 'undefined' && roleFilter === 'user' ? 'selected' : '' %>>User</option>
                                    <option value="admin" <%= typeof roleFilter !== 'undefined' && roleFilter === 'admin' ? 'selected' : '' %>>Admin</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" name="limit">
                                    <option value="10" <%= typeof limit !== 'undefined' && limit == 10 ? 'selected' : '' %>>10 per page</option>
                                    <option value="25" <%= typeof limit !== 'undefined' && limit == 25 ? 'selected' : '' %>>25 per page</option>
                                    <option value="50" <%= typeof limit !== 'undefined' && limit == 50 ? 'selected' : '' %>>50 per page</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fa fa-search me-2"></i>Search
                                </button>
                                <a href="/admin/users" class="btn btn-outline-secondary">
                                    <i class="fa fa-refresh me-2"></i>Reset
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">All Users</h6>
                    </div>
                    <div class="card-body">
                        <% if (typeof error !== 'undefined' && error) { %>
                        <div class="alert alert-danger">
                            <i class="fa fa-exclamation-circle me-2"></i><%= error %>
                        </div>
                        <% } %>

                        <% if (typeof users !== 'undefined' && users.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Newsletter</th>
                                        <th>Joined</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% users.forEach(function(user, index) { %>
                                    <tr>
                                        <td>#<%= String(user._id).substring(18, 24) %></td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px;">
                                                    <%= user.firstName.charAt(0).toUpperCase() %><%= user.lastName.charAt(0).toUpperCase() %>
                                                </div>
                                                <div>
                                                    <div class="fw-bold"><%= user.firstName %> <%= user.lastName %></div>
                                                    <% if (user.birthDate) { %>
                                                    <small class="text-muted">DOB: <%= new Date(user.birthDate).toLocaleDateString() %></small>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </td>
                                        <td><%= user.email %></td>
                                        <td><%= user.phone || 'N/A' %></td>
                                        <td>
                                            <% if (user.role === 'admin') { %>
                                            <span class="badge bg-danger">Admin</span>
                                            <% } else { %>
                                            <span class="badge bg-primary">User</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (typeof user.isActive !== 'undefined' && user.isActive === false) { %>
                                            <span class="badge bg-danger">Locked</span>
                                            <% } else { %>
                                            <span class="badge bg-success">Active</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (user.newsletter) { %>
                                            <span class="badge bg-success">Yes</span>
                                            <% } else { %>
                                            <span class="badge bg-secondary">No</span>
                                            <% } %>
                                        </td>
                                        <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="editUser('<%= user._id %>')" title="Edit">
                                                    <i class="fa fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-info" onclick="changeRole('<%= user._id %>', '<%= user.role %>')" title="Change Role">
                                                    <i class="fa fa-user-shield"></i>
                                                </button>
                                                <% if (typeof currentUser !== 'undefined' && currentUser && user._id.toString() !== currentUser.id.toString()) { %>
                                                <button class="btn btn-outline-<%= typeof user.isActive !== 'undefined' && user.isActive === false ? 'success' : 'warning' %>" 
                                                        onclick="toggleLock('<%= user._id %>', '<%= typeof user.isActive !== 'undefined' ? user.isActive : true %>', '<%= user.firstName %> <%= user.lastName %>')" 
                                                        title="<%= typeof user.isActive !== 'undefined' && user.isActive === false ? 'Unlock' : 'Lock' %> Account">
                                                    <i class="fa fa-<%= typeof user.isActive !== 'undefined' && user.isActive === false ? 'unlock' : 'lock' %>"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteUser('<%= user._id %>', '<%= user.firstName %> <%= user.lastName %>')" title="Delete">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                                <% } %>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <% if (typeof currentPage !== 'undefined' && currentPage > 1) { %>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<%= currentPage - 1 %><%= typeof search !== 'undefined' && search ? '&search=' + search : '' %><%= typeof roleFilter !== 'undefined' && roleFilter ? '&role=' + roleFilter : '' %><%= typeof limit !== 'undefined' ? '&limit=' + limit : '' %>">Previous</a>
                                </li>
                                <% } %>

                                <% for (let i = 1; i <= totalPages; i++) { %>
                                <% if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="?page=<%= i %><%= typeof search !== 'undefined' && search ? '&search=' + search : '' %><%= typeof roleFilter !== 'undefined' && roleFilter ? '&role=' + roleFilter : '' %><%= typeof limit !== 'undefined' ? '&limit=' + limit : '' %>"><%= i %></a>
                                </li>
                                <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                <% } %>
                                <% } %>

                                <% if (typeof currentPage !== 'undefined' && currentPage < totalPages) { %>
                                <li class="page-item">
                                    <a class="page-link" href="?page=<%= currentPage + 1 %><%= typeof search !== 'undefined' && search ? '&search=' + search : '' %><%= typeof roleFilter !== 'undefined' && roleFilter ? '&role=' + roleFilter : '' %><%= typeof limit !== 'undefined' ? '&limit=' + limit : '' %>">Next</a>
                                </li>
                                <% } %>
                            </ul>
                        </nav>
                        <% } %>
                        <% } else { %>
                        <div class="alert alert-info text-center">
                            <i class="fa fa-info-circle me-2"></i>No users found.
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addUserForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addFirstName" name="firstName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="addLastName" name="lastName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="addEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="addPhone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="addBirthDate" name="birthDate">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                <input type="password" class="form-control" id="addPassword" name="password" required minlength="6">
                                <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y pe-3" id="toggleAddPassword" style="z-index: 10; border: none; background: none; color: #6c757d; text-decoration: none;">
                                    <i class="fa fa-eye" id="addEyeIcon"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">Minimum 6 characters</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="addRole" name="role" required>
                                <option value="user" selected>User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="addNewsletter" name="newsletter">
                                <label class="form-check-label" for="addNewsletter">
                                    Subscribe to newsletter
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        <input type="hidden" id="editUserId" name="userId">
                        <div class="mb-3">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" name="firstName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" name="lastName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editPhone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="editBirthDate" name="birthDate">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="editRole" name="role" required>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editNewsletter" name="newsletter">
                                <label class="form-check-label" for="editNewsletter">
                                    Subscribe to newsletter
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/admin/js/admin.js"></script>
    <script>
        // Toggle password visibility for Add User form
        document.getElementById('toggleAddPassword')?.addEventListener('click', function() {
            const passwordInput = document.getElementById('addPassword');
            const eyeIcon = document.getElementById('addEyeIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        });

        // Show Add User Modal
        function showAddUserModal() {
            // Reset form
            document.getElementById('addUserForm').reset();
            // Reset password field type
            document.getElementById('addPassword').type = 'password';
            const eyeIcon = document.getElementById('addEyeIcon');
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
            
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        // Submit Add User Form
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    alert('Error: Server returned an invalid response. Please check the console for details.');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('User created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to create user'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        });

        // Edit User
        async function editUser(userId) {
            try {
                const response = await fetch(`/admin/users/${userId}`);
                const user = await response.json();
                
                document.getElementById('editUserId').value = user._id;
                document.getElementById('editFirstName').value = user.firstName;
                document.getElementById('editLastName').value = user.lastName;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editPhone').value = user.phone || '';
                document.getElementById('editBirthDate').value = user.birthDate ? new Date(user.birthDate).toISOString().split('T')[0] : '';
                document.getElementById('editRole').value = user.role;
                document.getElementById('editNewsletter').checked = user.newsletter || false;
                
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            } catch (error) {
                alert('Error loading user: ' + error.message);
            }
        }

        // Submit Edit Form
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('editUserId').value;
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('User updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to update user'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Change Role
        async function changeRole(userId, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            const confirmMsg = `Are you sure you want to change this user's role to ${newRole}?`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                const response = await fetch(`/admin/users/${userId}/role`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('User role updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to update role'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Toggle Lock/Unlock User
        async function toggleLock(userId, currentStatus, userName) {
            const isLocked = currentStatus === 'false' || currentStatus === false;
            const action = isLocked ? 'unlock' : 'lock';
            const confirmMsg = `Are you sure you want to ${action} the account of "${userName}"?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/users/${userId}/toggle-lock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    alert('Error: Server returned an invalid response. Please check the console for details.');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`User account ${action}ed successfully!`);
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || `Failed to ${action} user account`));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Delete User
        async function deleteUser(userId, userName) {
            if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('User deleted successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete user'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>

</html>
