<!DOCTYPE html>
<html lang="en">

    <head>
        <%- include('partical/head'); %>
    </head>

    <body>

        <!-- Spinner Start -->
        <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->

        <% var activePage = 'booking'; %>
        <%- include('partical/menu'); %>

        <!-- Header Start -->
        <div class="container-fluid bg-breadcrumb">
            <div class="container text-center py-5" style="max-width: 900px;">
                <h3 class="text-white display-3 mb-4">Online Booking</h1>
                <ol class="breadcrumb justify-content-center mb-0">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="#">Pages</a></li>
                    <li class="breadcrumb-item active text-white">Online Booking</li>
                </ol>    
            </div>
        </div>
        <!-- Header End -->

        <!-- Tour Booking Start -->
        <div class="container-fluid booking py-5">
            <div class="container py-5">
                <div class="row g-5 align-items-center">
                    <div class="col-lg-6">
                        <h5 class="section-booking-title pe-3">Booking</h5>
                        <h1 class="text-white mb-4">Online Booking</h1>
                        <p class="text-white mb-4">Lorem ipsum dolor sit amet consectetur adipisicing elit. Aspernatur maxime ullam esse fuga blanditiis accusantium pariatur quis sapiente, veniam doloribus praesentium? Repudiandae iste voluptatem fugiat doloribus quasi quo iure officia.
                        </p>
                        <p class="text-white mb-4">Lorem ipsum dolor sit amet consectetur adipisicing elit. Aspernatur maxime ullam esse fuga blanditiis accusantium pariatur quis sapiente, veniam doloribus praesentium? Repudiandae iste voluptatem fugiat doloribus quasi quo iure officia.
                        </p>
                        <a href="#" class="btn btn-light text-primary rounded-pill py-3 px-5 mt-2">Read More</a>
                    </div>
                    <div class="col-lg-6">
                        <h1 class="text-white mb-3">Book A Tour</h1>
                        <p class="text-white mb-4">Get <span class="text-warning">50% Off</span> On Your First Adventure Trip With HereWeGo. Get More Deal Offers Here.</p>
                        
                        <% if (typeof error !== 'undefined' && error) { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fa fa-exclamation-circle me-2"></i><%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <% } %>
                        
                        <% if (typeof success !== 'undefined' && success) { %>
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fa fa-check-circle me-2"></i><%= success %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <% if (typeof booking !== 'undefined' && booking && booking.paymentStatus === 'pending') { %>
                        <div class="card bg-light border-primary mb-4">
                            <div class="card-body">
                                <h5 class="card-title text-primary">
                                    <i class="fa fa-credit-card me-2"></i>Thanh toán ngay
                                </h5>
                                <p class="card-text mb-3">
                                    Bạn có thể thanh toán ngay bằng VNPay để xác nhận đặt tour.
                                </p>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <strong>Tổng tiền:</strong> 
                                        <span class="text-primary fs-4">$<%= booking.totalPrice.toFixed(2) %></span>
                                        <small class="text-muted">(~<%= Math.round(booking.totalPrice * 24000).toLocaleString('vi-VN') %> VND)</small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary btn-lg w-100" id="payWithVNPayBtn" data-booking-id="<%= booking._id %>">
                                    <i class="fa fa-credit-card me-2"></i>Thanh toán bằng VNPay
                                </button>
                            </div>
                        </div>
                        <% } %>
                        <% } %>
                        
                        <% if (typeof tour !== 'undefined' && tour) { %>
                        <div class="card bg-white mb-4">
                            <div class="card-body">
                                <h5 class="card-title text-primary"><%= tour.title %></h5>
                                <p class="card-text mb-2"><i class="fa fa-map-marker-alt me-2"></i><%= tour.destination %></p>
                                <p class="card-text mb-2"><i class="fa fa-calendar-alt me-2"></i><%= tour.duration %> <%= tour.durationUnit || 'days' %></p>
                                <p class="card-text mb-0">
                                    <strong>Price: </strong>
                                    <% if (tour.discountPrice) { %>
                                    <span class="text-decoration-line-through text-muted">$<%= tour.price.toFixed(2) %></span>
                                    <span class="text-danger fw-bold">$<%= tour.discountPrice.toFixed(2) %></span> per person
                                    <% } else { %>
                                    <span class="fw-bold">$<%= tour.price.toFixed(2) %></span> per person
                                    <% } %>
                                </p>
                            </div>
                        </div>
                        <% } %>
                        
                        <% if (typeof user === 'undefined' || !user) { %>
                        <div class="alert alert-info mb-4">
                            <i class="fa fa-info-circle me-2"></i>
                            <a href="/login" class="alert-link">Login</a> to auto-fill your information, or 
                            <a href="/register" class="alert-link">Register</a> for a new account.
                        </div>
                        <% } %>
                        
                        <form method="POST" action="/booking" id="bookingForm">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control bg-white border-0" id="guestName" name="guestName" 
                                               placeholder="Your Name" 
                                               value="<%= typeof user !== 'undefined' && user ? user.firstName + ' ' + user.lastName : (typeof formData !== 'undefined' && formData.guestName ? formData.guestName : '') %>"
                                               required>
                                        <label for="guestName">Your Name <span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="email" class="form-control bg-white border-0" id="guestEmail" name="guestEmail" 
                                               placeholder="Your Email"
                                               value="<%= typeof user !== 'undefined' && user ? user.email : (typeof formData !== 'undefined' && formData.guestEmail ? formData.guestEmail : '') %>"
                                               required>
                                        <label for="guestEmail">Your Email <span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="tel" class="form-control bg-white border-0" id="guestPhone" name="guestPhone" 
                                               placeholder="Your Phone"
                                               value="<%= typeof user !== 'undefined' && user && user.phone ? user.phone : (typeof formData !== 'undefined' && formData.guestPhone ? formData.guestPhone : '') %>">
                                        <label for="guestPhone">Your Phone</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select bg-white border-0" id="tourSelect" name="tourId" required>
                                            <option value="">Select a Tour</option>
                                            <% if (typeof tours !== 'undefined' && tours.length > 0) { %>
                                                <% tours.forEach(function(t) { %>
                                                <option value="<%= t._id %>" 
                                                        <%= typeof tour !== 'undefined' && tour && tour._id.toString() === t._id.toString() ? 'selected' : '' %>>
                                                    <%= t.title %> - <%= t.destination %> ($<%= t.discountPrice ? t.discountPrice.toFixed(2) : t.price.toFixed(2) %>)
                                                </option>
                                                <% }); %>
                                            <% } %>
                                        </select>
                                        <label for="tourSelect">Select Tour <span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <% if (typeof tour !== 'undefined' && tour && tour.availableDates && tour.availableDates.length > 0) { %>
                                        <select class="form-select bg-white border-0" id="bookingDate" name="bookingDate" required>
                                            <option value="">Chọn ngày khởi hành</option>
                                            <% tour.availableDates.forEach(function(date) { %>
                                            <option value="<%= new Date(date).toISOString().split('T')[0] %>"
                                                    <%= typeof formData !== 'undefined' && formData.bookingDate === new Date(date).toISOString().split('T')[0] ? 'selected' : '' %>>
                                                <%= new Date(date).toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                                            </option>
                                            <% }); %>
                                        </select>
                                        <label for="bookingDate">Ngày khởi hành <span class="text-danger">*</span></label>
                                        <small class="text-muted d-block mt-1">
                                            <i class="fa fa-info-circle me-1"></i>Chỉ có thể chọn các ngày khởi hành có sẵn
                                        </small>
                                        <% } else { %>
                                        <select class="form-select bg-white border-0" id="bookingDate" name="bookingDate" disabled>
                                            <option value="">Chưa có lịch khởi hành</option>
                                        </select>
                                        <label for="bookingDate">Ngày khởi hành <span class="text-danger">*</span></label>
                                        <div class="alert alert-warning mt-2 mb-0">
                                            <i class="fa fa-exclamation-triangle me-2"></i>
                                            Tour này chưa có lịch khởi hành. Vui lòng liên hệ hotline <strong>+84 123 456 789</strong> để đặt tour.
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="number" class="form-control bg-white border-0" id="numberOfPersons" name="numberOfPersons" 
                                               placeholder="Number of Persons" 
                                               min="1" 
                                               max="<%= typeof tour !== 'undefined' && tour && tour.maxPersons ? tour.maxPersons : '' %>"
                                               value="<%= typeof formData !== 'undefined' && formData.numberOfPersons ? formData.numberOfPersons : '1' %>"
                                               required>
                                        <label for="numberOfPersons">Number of Persons <span class="text-danger">*</span></label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control bg-white border-0" placeholder="Special Request" id="specialRequest" name="specialRequest" style="height: 100px"><%= typeof formData !== 'undefined' && formData.specialRequest ? formData.specialRequest : '' %></textarea>
                                        <label for="specialRequest">Special Request</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="bg-white rounded p-3 mb-3">
                                        <h6 class="mb-2">Price Summary</h6>
                                        <div id="priceSummary">
                                            <p class="mb-1">Price per person: <span id="pricePerPerson">$0.00</span></p>
                                            <p class="mb-1">Number of persons: <span id="personsCount">1</span></p>
                                            <hr>
                                            <p class="mb-0 fw-bold">Total: <span id="totalPrice" class="text-primary">$0.00</span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-primary text-white w-100 py-3" type="submit">
                                        <i class="fa fa-calendar-check me-2"></i>Book Now
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tour Booking End -->

        <!-- Subscribe Start -->
        <div class="container-fluid subscribe py-5">
            <div class="container text-center py-5">
                <div class="mx-auto text-center" style="max-width: 900px;">
                    <h5 class="subscribe-title px-3">Subscribe</h5>
                    <h1 class="text-white mb-4">Our Newsletter</h1>
                    <p class="text-white mb-5">Lorem ipsum dolor sit amet consectetur adipisicing elit. Laborum tempore nam, architecto doloremque velit explicabo? Voluptate sunt eveniet fuga eligendi! Expedita laudantium fugiat corrupti eum cum repellat a laborum quasi.
                    </p>
                    <div class="position-relative mx-auto">
                        <input class="form-control border-primary rounded-pill w-100 py-3 ps-4 pe-5" type="text" placeholder="Your email">
                        <button type="button" class="btn btn-primary rounded-pill position-absolute top-0 end-0 py-2 px-4 mt-2 me-2">Subscribe</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Subscribe End -->

        <%- include('partical/footer'); %>

        <script>
            // Tour data for price calculation
            const tours = {
                <% if (typeof tours !== 'undefined' && tours.length > 0) { %>
                    <% tours.forEach(function(t) { %>
                    '<%= t._id %>': {
                        price: <%= t.price %>,
                        discountPrice: <%= t.discountPrice || 'null' %>,
                        maxPersons: <%= t.maxPersons || 'null' %>
                    },
                    <% }); %>
                <% } %>
            };

            const tourAvailableDates = {
                <% if (typeof tour !== 'undefined' && tour && tour.availableDates && tour.availableDates.length > 0) { %>
                    '<%= tour._id %>': [
                        <% tour.availableDates.forEach(function(date, idx) { %>
                        '<%= new Date(date).toISOString().split('T')[0] %>'<%= idx < tour.availableDates.length - 1 ? ',' : '' %>
                        <% }); %>
                    ]
                <% } %>
            };

            // Update price when tour or persons change
            function updatePrice() {
                const tourId = document.getElementById('tourSelect').value;
                const persons = parseInt(document.getElementById('numberOfPersons').value) || 1;
                
                if (tourId && tours[tourId]) {
                    const tour = tours[tourId];
                    const pricePerPerson = tour.discountPrice || tour.price;
                    const totalPrice = pricePerPerson * persons;
                    
                    document.getElementById('pricePerPerson').textContent = '$' + pricePerPerson.toFixed(2);
                    document.getElementById('personsCount').textContent = persons;
                    document.getElementById('totalPrice').textContent = '$' + totalPrice.toFixed(2);
                    
                    // Update max persons
                    if (tour.maxPersons) {
                        document.getElementById('numberOfPersons').setAttribute('max', tour.maxPersons);
                    } else {
                        document.getElementById('numberOfPersons').removeAttribute('max');
                    }
                } else {
                    document.getElementById('pricePerPerson').textContent = '$0.00';
                    document.getElementById('personsCount').textContent = '1';
                    document.getElementById('totalPrice').textContent = '$0.00';
                }
            }

            async function updateDateSelector(tourId) {
                const dateContainer = document.getElementById('bookingDate')?.parentElement;
                if (!dateContainer) return;

                if (!tourId) {
                    const select = document.getElementById('bookingDate');
                    if (select && select.tagName === 'SELECT') {
                        select.innerHTML = '<option value="">Chọn tour trước</option>';
                    }
                    return;
                }

                try {
                    const response = await fetch(`/api/tours/${tourId}`);
                    if (response.ok) {
                        const result = await response.json();
                        const tour = result.data || result;
                        
                        if (tour.availableDates && tour.availableDates.length > 0) {
                            const futureDates = tour.availableDates
                                .map(d => new Date(d))
                                .filter(d => d >= new Date())
                                .sort((a, b) => a - b);
                            
                            const select = document.createElement('select');
                            select.className = 'form-select bg-white border-0';
                            select.id = 'bookingDate';
                            select.name = 'bookingDate';
                            select.required = true;
                            
                            if (futureDates.length > 0) {
                                select.innerHTML = '<option value="">Chọn ngày khởi hành</option>';
                                futureDates.forEach(date => {
                                    const option = document.createElement('option');
                                    option.value = date.toISOString().split('T')[0];
                                    option.textContent = date.toLocaleDateString('vi-VN', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    });
                                    select.appendChild(option);
                                });
                                
                                const smallInfo = document.createElement('small');
                                smallInfo.className = 'text-muted d-block mt-1';
                                smallInfo.innerHTML = '<i class="fa fa-info-circle me-1"></i>Chỉ có thể chọn các ngày khởi hành có sẵn';
                                dateContainer.appendChild(smallInfo);
                            } else {
                                select.innerHTML = '<option value="">Không có ngày khởi hành</option>';
                                select.disabled = true;
                                
                                const alertDiv = document.createElement('div');
                                alertDiv.className = 'alert alert-warning mt-2 mb-0';
                                alertDiv.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>Tour này chưa có lịch khởi hành. Vui lòng liên hệ hotline <strong>+84 123 456 789</strong> để đặt tour.';
                                dateContainer.appendChild(alertDiv);
                            }
                            
                            const oldElement = document.getElementById('bookingDate');
                            const label = dateContainer.querySelector('label');
                            if (oldElement) {
                                dateContainer.replaceChild(select, oldElement);
                            } else {
                                dateContainer.appendChild(select);
                            }
                            if (label) {
                                label.innerHTML = 'Ngày khởi hành <span class="text-danger">*</span>';
                            }
                        } else {
                            const select = document.createElement('select');
                            select.className = 'form-select bg-white border-0';
                            select.id = 'bookingDate';
                            select.name = 'bookingDate';
                            select.disabled = true;
                            select.innerHTML = '<option value="">Chưa có lịch khởi hành</option>';
                            
                            const oldElement = document.getElementById('bookingDate');
                            const label = dateContainer.querySelector('label');
                            if (oldElement) {
                                dateContainer.replaceChild(select, oldElement);
                            } else {
                                dateContainer.appendChild(select);
                            }
                            if (label) {
                                label.innerHTML = 'Ngày khởi hành <span class="text-danger">*</span>';
                            }
                            
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-warning mt-2 mb-0';
                            alertDiv.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>Tour này chưa có lịch khởi hành. Vui lòng liên hệ hotline <strong>+84 123 456 789</strong> để đặt tour.';
                            dateContainer.appendChild(alertDiv);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching tour dates:', error);
                }
            }

            document.getElementById('tourSelect')?.addEventListener('change', function() {
                updatePrice();
                updateDateSelector(this.value);
            });

            // Update price when number of persons changes
            document.getElementById('numberOfPersons')?.addEventListener('input', updatePrice);

            // Initialize price on page load
            document.addEventListener('DOMContentLoaded', function() {
                updatePrice();
            });

            // Form validation
            document.getElementById('bookingForm')?.addEventListener('submit', function(e) {
                const tourId = document.getElementById('tourSelect').value;
                const bookingDate = document.getElementById('bookingDate');
                
                if (!tourId) {
                    e.preventDefault();
                    alert('Vui lòng chọn tour');
                    return false;
                }
                
                if (!bookingDate || !bookingDate.value || bookingDate.disabled) {
                    e.preventDefault();
                    alert('Vui lòng chọn ngày khởi hành. Tour này chỉ có thể đặt các ngày do admin tạo.');
                    return false;
                }
            });

            // VNPay payment button handler
            document.getElementById('payWithVNPayBtn')?.addEventListener('click', async function() {
                const bookingId = this.getAttribute('data-booking-id');
                const btn = this;
                
                // Disable button and show loading
                btn.disabled = true;
                btn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Đang xử lý...';
                
                try {
                    const response = await fetch(`/booking/${bookingId}/payment/vnpay`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.paymentUrl) {
                        // Redirect to VNPay payment page
                        window.location.href = data.paymentUrl;
                    } else {
                        alert('Có lỗi xảy ra: ' + (data.message || 'Không thể tạo link thanh toán'));
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa fa-credit-card me-2"></i>Thanh toán bằng VNPay';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tạo link thanh toán. Vui lòng thử lại.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa fa-credit-card me-2"></i>Thanh toán bằng VNPay';
                }
            });
        </script>
    </body>

</html>